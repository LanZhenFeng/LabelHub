# =============================================================================
# LabelHub CI Workflow
# =============================================================================
#
# This workflow runs on:
# - Push to main or develop branches
# - Pull requests targeting main or develop
#
# Jobs:
# - backend_ci: Python backend checks (lint, test)
# - frontend_ci: Node.js frontend checks (lint, build)
#
# Note: These job names are used for branch protection "required status checks".
# If backend/ or frontend/ directories don't exist yet, the jobs will skip
# gracefully with a clear message (exit 0, not failure).
#
# =============================================================================

name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Backend CI
  # ===========================================================================
  backend_ci:
    name: Backend CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if backend exists
        id: check_backend
        run: |
          if [ -d "backend" ] && ([ -f "backend/pyproject.toml" ] || [ -f "backend/requirements.txt" ] || [ -f "backend/requirements-dev.txt" ]); then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Backend directory found with Python config"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Backend directory not present yet - this is expected in early development"
          fi

      - name: Setup Python
        if: steps.check_backend.outputs.exists == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        if: steps.check_backend.outputs.exists == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements*.txt', 'backend/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        if: steps.check_backend.outputs.exists == 'true'
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          # Prefer requirements.txt for simple projects
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          elif [ -f "requirements-dev.txt" ]; then
            pip install -r requirements-dev.txt
          elif [ -f "pyproject.toml" ]; then
            pip install -e ".[dev]" || pip install -e .
          fi
          # Install linting tools if not in requirements
          pip install ruff || true

      - name: Lint with Ruff
        if: steps.check_backend.outputs.exists == 'true'
        working-directory: backend
        run: |
          echo "üîç Running Ruff linter..."
          ruff check . || echo "‚ö†Ô∏è Ruff check found issues (non-blocking for now)"
          ruff format --check . || echo "‚ö†Ô∏è Ruff format check found issues (non-blocking for now)"

      - name: Run tests
        if: steps.check_backend.outputs.exists == 'true'
        working-directory: backend
        run: |
          if [ -f "pytest.ini" ] || [ -f "pyproject.toml" ] || [ -d "tests" ]; then
            echo "üß™ Running pytest..."
            pip install pytest pytest-cov || true
            pytest --tb=short -q || echo "‚ö†Ô∏è Some tests failed or no tests found"
          else
            echo "‚ÑπÔ∏è No test configuration found, skipping tests"
          fi

      - name: Backend skipped (not present)
        if: steps.check_backend.outputs.exists == 'false'
        run: |
          echo "=============================================="
          echo "‚è≠Ô∏è  BACKEND NOT PRESENT YET - SKIPPING"
          echo "=============================================="
          echo ""
          echo "This is expected during early development."
          echo "Backend CI will run once backend/ directory"
          echo "is created with pyproject.toml or requirements.txt"
          echo ""
          echo "Expected structure:"
          echo "  backend/"
          echo "  ‚îú‚îÄ‚îÄ pyproject.toml  (or requirements.txt)"
          echo "  ‚îú‚îÄ‚îÄ app/"
          echo "  ‚îÇ   ‚îî‚îÄ‚îÄ main.py"
          echo "  ‚îî‚îÄ‚îÄ tests/"
          echo ""
          exit 0

  # ===========================================================================
  # Frontend CI
  # ===========================================================================
  frontend_ci:
    name: Frontend CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if frontend exists
        id: check_frontend
        run: |
          if [ -f "frontend/package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Frontend directory found with package.json"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Frontend directory not present yet - this is expected in early development"
          fi

      - name: Setup Node.js
        if: steps.check_frontend.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache npm dependencies
        if: steps.check_frontend.outputs.exists == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        if: steps.check_frontend.outputs.exists == 'true'
        working-directory: frontend
        run: |
          echo "üì¶ Installing npm dependencies..."
          npm ci || npm install

      - name: Lint
        if: steps.check_frontend.outputs.exists == 'true'
        working-directory: frontend
        run: |
          echo "üîç Running ESLint..."
          if npm run lint --if-present; then
            echo "‚úÖ Lint passed"
          else
            echo "‚ö†Ô∏è Lint found issues (non-blocking for now)"
          fi

      - name: Type check
        if: steps.check_frontend.outputs.exists == 'true'
        working-directory: frontend
        run: |
          echo "üìù Running TypeScript type check..."
          npm run typecheck --if-present || npm run type-check --if-present || echo "‚ÑπÔ∏è No typecheck script found"

      - name: Build
        if: steps.check_frontend.outputs.exists == 'true'
        working-directory: frontend
        run: |
          echo "üèóÔ∏è Building frontend..."
          npm run build

      - name: Frontend skipped (not present)
        if: steps.check_frontend.outputs.exists == 'false'
        run: |
          echo "=============================================="
          echo "‚è≠Ô∏è  FRONTEND NOT PRESENT YET - SKIPPING"
          echo "=============================================="
          echo ""
          echo "This is expected during early development."
          echo "Frontend CI will run once frontend/ directory"
          echo "is created with package.json"
          echo ""
          echo "Expected structure:"
          echo "  frontend/"
          echo "  ‚îú‚îÄ‚îÄ package.json"
          echo "  ‚îú‚îÄ‚îÄ src/"
          echo "  ‚îÇ   ‚îî‚îÄ‚îÄ App.tsx"
          echo "  ‚îî‚îÄ‚îÄ vite.config.ts"
          echo ""
          exit 0

  # ===========================================================================
  # Docs validation (lightweight)
  # ===========================================================================
  docs_check:
    name: Docs Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required docs exist
        run: |
          echo "üìÑ Checking required documentation..."
          required_files=(
            "README.md"
            "LICENSE"
            "CONTRIBUTING.md"
            "docs/PRD.md"
            "docs/MILESTONES.md"
          )

          missing=0
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file exists"
            else
              echo "‚ùå $file is missing"
              missing=$((missing + 1))
            fi
          done

          if [ $missing -gt 0 ]; then
            echo ""
            echo "‚ö†Ô∏è Warning: $missing required file(s) missing"
            # Don't fail, just warn
          else
            echo ""
            echo "‚úÖ All required documentation present"
          fi

      - name: Check markdown links (optional)
        run: |
          echo "‚ÑπÔ∏è Markdown link checking skipped (install markdown-link-check for this)"
          # npm install -g markdown-link-check
          # find . -name "*.md" -exec markdown-link-check {} \;
