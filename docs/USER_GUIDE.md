# LabelHub 用户指南

> Version: v1.0-MVP  
> Last Updated: 2025-12-14

---

## 目录

- [快速开始](#快速开始)
- [项目管理](#项目管理)
- [数据集管理](#数据集管理)
- [标注操作](#标注操作)
  - [分类标注](#分类标注)
  - [检测标注（BBox）](#检测标注bbox)
  - [分割标注（Polygon）](#分割标注polygon)
- [预标注导入](#预标注导入)
- [数据导出](#数据导出)
- [统计与Dashboard](#统计与dashboard)
- [常见问题](#常见问题)

---

## 快速开始

### 1. 访问系统

通过浏览器访问 LabelHub（默认：`http://localhost:3000`）

### 2. 创建项目

1. 点击「+ New Project」按钮
2. 输入项目名称和描述（可选）
3. 选择任务类型：
   - **Classification**: 图片分类
   - **Detection**: 目标检测（矩形框）
   - **Segmentation**: 语义分割（多边形）
4. 添加标签（类别）：
   - 输入标签名称
   - 选择颜色（用于标注可视化）
   - 设置快捷键（可选，1-9）
5. 点击「Create」创建项目

### 3. 创建数据集并导入图片

1. 进入项目，点击「+ Add Dataset」
2. 输入数据集名称和描述（可选）
3. 选择导入方式：
   - **服务器路径扫描**（推荐）：填写服务器上图片目录的绝对路径，系统会索引该目录下的所有图片（支持`.jpg`, `.jpeg`, `.png`, `.webp`）
   - ⚠️ 注意：服务器路径必须可被后端容器访问（Docker部署时需挂载卷）
4. 点击「Scan」开始导入

### 4. 开始标注

1. 在数据集页面点击「Start Annotation」按钮
2. 根据任务类型进行标注（详见下方标注操作部分）
3. 使用快捷键提高效率（按 `?` 查看所有快捷键）

---

## 项目管理

### 查看项目列表

- 首页显示所有项目卡片
- 每个卡片显示：
  - 项目名称、类型、创建时间
  - 进度条（完成率）
  - 数据集数量和前3个数据集的快捷链接
  - Dashboard按钮（查看统计信息）

### 编辑项目

⚠️ MVP版本暂不支持项目编辑，请在创建时确认所有信息。

### 删除项目

1. 在项目卡片上点击「Delete」按钮
2. 确认删除操作
3. ⚠️ 删除项目会级联删除其下所有数据集、标注数据

---

## 数据集管理

### 查看数据集

1. 点击项目进入数据集列表
2. 支持两种视图：
   - **网格视图**（默认）：显示缩略图
   - **列表视图**：紧凑显示，适合大数据集

### 过滤图片

- 顶部筛选栏支持按状态过滤：
  - **All**: 所有图片
  - **To Do**: 未标注
  - **Done**: 已完成
  - **Skipped**: 已跳过

### 虚拟列表优化

- 当数据集图片数 > 50 张时，自动启用虚拟列表
- 只渲染可见区域，大幅提升性能
- 支持滚动分页（每页100张）

---

## 标注操作

### 分类标注

#### 界面布局

```
┌─────────────────────────────────────────────────────────┐
│ Header: 图片名称、进度、导航按钮                          │
├──────────────────────┬──────────────────────────────────┤
│                      │  Sidebar:                        │
│                      │  - 标签选择（1-9快捷键）         │
│   Canvas 图片查看器   │  - 上一张/下一张按钮             │
│   (支持缩放/平移)     │  - Submit 按钮                  │
│                      │  - Skip 按钮                    │
│                      │  - Delete 按钮                  │
│                      │  - 快捷键提示                   │
└──────────────────────┴──────────────────────────────────┘
```

#### 操作步骤

1. 观察图片内容
2. 按数字键 `1-9` 或点击标签选择分类
3. 按 `Enter` 提交并跳转到下一张未标注图片

#### 快捷键

| 快捷键 | 功能 |
|--------|------|
| `1-9` | 选择对应标签 |
| `Enter` | 提交并下一张（未标注） |
| `←` | 上一张（按顺序） |
| `→` | 下一张（按顺序） |
| `S` | 跳过当前图片 |
| `Ctrl+Delete` | 删除当前图片 |
| `Scroll` | 缩放图片 |
| `Space + 拖拽` 或 `中键拖拽` | 平移图片 |
| `Double Click` | 重置缩放 |

### 检测标注（BBox）

#### 界面布局

```
┌─────────────────────────────────────────────────────────┐
│ Header: 导航、标注数、Undo/Redo、Zoom、帮助              │
├──────────────────────┬──────────────────────────────────┤
│                      │  Sidebar:                        │
│                      │  - 工具选择（V/R/P）             │
│   Fabric.js 画布     │  - 标签选择（1-9快捷键）         │
│   (支持绘制/编辑)     │  - Submit/Skip/Delete           │
│                      │  - 快捷键提示                   │
└──────────────────────┴──────────────────────────────────┘
```

#### 操作步骤

1. **绘制矩形框**：
   - 按 `R` 或点击「Rectangle」工具
   - 选择标签（按 `1-9` 或点击）
   - 在画布上拖拽绘制矩形框
   - 松开鼠标完成绘制
   
2. **编辑矩形框**：
   - 按 `V` 或点击「Select」工具
   - 点击选中要编辑的框
   - 拖拽移动位置
   - 拖拽边框调整大小（8个方向）
   - 按 `Delete` 删除选中的框
   
3. **提交标注**：
   - 绘制完所有目标后，按 `Enter` 或点击「Submit」
   - 系统自动跳转到下一张未标注图片

#### 快捷键

| 快捷键 | 功能 |
|--------|------|
| `V` | 选择工具 |
| `R` | 矩形工具 |
| `1-9` | 选择标签 |
| `Delete` | 删除选中标注 |
| `Ctrl+Z` | 撤销 |
| `Ctrl+Y` | 重做 |
| `Enter` | 提交并下一张 |
| `←` / `→` | 上一张/下一张（按顺序） |
| `S` | 跳过 |
| `Scroll` | 缩放画布 |
| `Space + 拖拽` 或 `中键拖拽` | 平移画布 |
| `?` | 显示帮助 |

### 分割标注（Polygon）

#### 操作步骤

1. **绘制多边形**：
   - 按 `P` 或点击「Polygon」工具
   - 选择标签（按 `1-9` 或点击）
   - 在画布上依次点击添加顶点
   - 双击或按 `Enter` 闭合多边形
   
2. **编辑多边形**：
   - 按 `V` 选择工具
   - 点击选中要编辑的多边形
   - 拖拽顶点调整形状
   - 按 `Delete` 删除选中的多边形
   
3. **提交标注**：
   - 绘制完所有目标后，按 `Enter` 或点击「Submit」

#### 快捷键

与检测标注相同，额外增加：

| 快捷键 | 功能 |
|--------|------|
| `P` | 多边形工具 |
| `Enter`（绘制时） | 闭合多边形 |
| `Double Click`（绘制时） | 闭合多边形 |

#### 绘制技巧

- **精确绘制**：放大画布（滚轮）后点击顶点，更精确
- **简化顶点**：尽量用最少的顶点描述边界，提高效率
- **避免交叉**：多边形边不应交叉，否则可能导致渲染错误

---

## 预标注导入

LabelHub 支持通过 **Parser Template 系统** 导入任意格式的预标注数据。

### 导入流程

1. **进入导入页面**：
   - 在数据集页面点击「Import」按钮
   
2. **上传/粘贴数据**（左栏）：
   - 上传 JSON 或 JSONL 文件
   - 或直接粘贴数据内容
   
3. **选择/编辑模板**（中栏）：
   - 选择内置模板（COCO、YOLO、VOC）
   - 或创建自定义模板（使用 JMESPath 表达式）
   - 点击「Test Parse」预览解析结果
   
4. **预览与映射**（右栏）：
   - 查看解析出的预标注结果
   - 映射类别名称到项目标签
   - 设置置信度阈值过滤
   - 选择冲突解决策略（覆盖/跳过）
   
5. **确认导入**：
   - 点击「Import」开始导入
   - 导入完成后，预标注会显示在标注页面

### 内置模板

#### COCO 格式

```json
{
  "images": [{"id": 1, "file_name": "img1.jpg"}],
  "annotations": [
    {
      "image_id": 1,
      "category_id": 1,
      "bbox": [x, y, width, height],
      "score": 0.95
    }
  ],
  "categories": [{"id": 1, "name": "person"}]
}
```

#### YOLO 格式 (JSONL)

```jsonl
{"image": "img1.jpg", "class": 0, "bbox": [x_center, y_center, width, height], "confidence": 0.95}
```

#### VOC 格式 (XML → JSON)

需先转换为 JSON 格式，模板会自动解析 `<object>` 标签。

### 自定义模板

参见 [Parser Template 编写指南](#parser-template-编写指南)。

---

## 数据导出

### 支持格式

#### 分类任务

- **CSV**: 图片路径 + 标签列，适合表格分析
- **JSON**: 结构化 JSON，包含所有标注信息
- **ImageNet**: 文件夹分类格式，每个类别一个文件夹

#### 检测/分割任务

- **COCO**: 标准 COCO JSON 格式
- **YOLO**: YOLO 训练格式（JSONL）
- **Pascal VOC**: VOC XML 格式

### 导出步骤

1. 在数据集页面点击「Export」按钮
2. 选择导出格式
3. 勾选「Include Images」（可选）：
   - 勾选：导出 ZIP 包含图片
   - 不勾选：仅导出标注文件
4. 点击「Export」开始导出
5. 等待导出完成，浏览器自动下载 ZIP 文件

### 导出内容

```
export_{dataset_name}_{timestamp}.zip
├── annotations/
│   ├── coco_annotations.json    # COCO格式
│   ├── labels.txt                # YOLO类别列表
│   └── ...
└── images/                       # (如果勾选Include Images)
    ├── img1.jpg
    └── ...
```

---

## 统计与Dashboard

### 访问Dashboard

1. 在项目卡片上点击「Dashboard」按钮
2. 或通过 URL 访问：`/projects/{projectId}/dashboard`

### KPI指标

#### 完成率（Completion Rate）

- **计算方式**：`已完成数 / 总数 × 100%`
- **目标**：≥ 80%
- **趋势图标**：
  - ✓ 绿色向上箭头：达标
  - ✗ 红色向下箭头：未达标

#### 平均标注耗时（Avg Annotation Time）

- **计算方式**：所有提交事件的平均耗时
- **单位**：秒/张
- **目标**：
  - 分类 < 10s
  - 检测 < 60s
  - 分割 < 120s

#### 日吞吐量（Daily Throughput）

- **计算方式**：最近7天日均完成数
- **单位**：张/天
- **目标**：
  - 分类 > 500
  - 检测 > 200
  - 分割 > 100

#### 跳过率（Skip Rate）

- **计算方式**：`跳过数 / 总数 × 100%`
- **目标**：< 5%

#### 预标注采纳率（Pre-annotation Adoption Rate）

- **计算方式**：`直接采纳数 / 有预标注的总数 × 100%`
- **目标**：> 60%
- **说明**：仅在导入预标注后显示

#### 预标注修改率（Pre-annotation Modification Rate）

- **计算方式**：`修改后采纳数 / 有预标注的总数 × 100%`
- **目标**：< 30%

### 可视化图表

#### 状态分布（饼图）

显示 Todo / In Progress / Done / Skipped 的数量占比。

#### 类别分布（柱状图）

显示各类别的标注数量，帮助发现数据不平衡问题。

#### 每日进度（折线图）

最近30天的完成数和跳过数趋势，帮助跟踪项目进度和标注员表现。

#### 标注员统计（表格）

- MVP版本仅显示单用户（Default User）
- 包含：完成数、平均耗时、贡献度、跳过率
- v1.1将支持多用户统计和排名

---

## 常见问题

### 1. 服务器路径扫描失败？

**原因**：后端无法访问指定路径

**解决方案**：
- **Docker 部署**：确保在 `docker-compose.yml` 中挂载了图片目录：
  ```yaml
  backend:
    volumes:
      - /host/path/to/images:/data/images:ro  # 只读挂载
  ```
  然后在导入时填写容器内路径：`/data/images`

- **本地开发**：直接使用绝对路径，确保后端进程有读取权限

### 2. 缩略图加载慢？

**原因**：首次访问时生成缩略图

**解决方案**：
- 缩略图会自动缓存（WebP格式，256x256）
- 支持 HTTP 缓存（ETag），二次访问极快
- 启用 IndexedDB 缓存（200MB），离线可用

### 3. 标注丢失或不显示？

**排查步骤**：
1. 检查浏览器控制台是否有错误
2. 刷新页面，确认数据是否已保存
3. 检查 `/next-item` API 是否返回正确数据
4. 查看后端日志（`docker-compose logs backend`）

### 4. 快捷键冲突？

**解决方案**：
- 确保焦点在标注页面（不在输入框）
- 避免浏览器默认快捷键（如 `Ctrl+S`）
- v1.1 将支持自定义快捷键映射

### 5. 如何备份数据？

**数据库备份**：
```bash
# SQLite (本地开发)
cp backend/labelhub.db labelhub_backup_$(date +%Y%m%d).db

# PostgreSQL (Docker)
docker-compose exec postgres pg_dump -U labelhub labelhub > backup.sql
```

**导出标注数据**：
使用「Export」功能导出所有标注为 COCO/YOLO/VOC 格式。

### 6. 支持多人协作吗？

**MVP 版本**：
- 单用户模式，无需登录
- 多人可访问同一实例，但无权限隔离

**v1.1 计划**：
- JWT 认证
- 多用户角色（标注员/管理员/审阅者）
- 任务分配与冲突检测

### 7. 支持视频标注吗？

**MVP 版本**：不支持

**未来计划**：
- v1.2: 视频帧提取 + 关键帧标注
- v1.3: 目标追踪 + 插值

---

## Parser Template 编写指南

### 概述

Parser Template 使用 **JMESPath** 表达式从任意 JSON/JSONL 数据中提取预标注信息。

### 模板结构

```json
{
  "name": "My Custom Template",
  "description": "Description of the template",
  "input_type": "json" | "jsonl",
  "input_encoding": "utf-8",
  "record_path": "data.annotations",  // Optional: nested array path
  "mapping": {
    "image_key": "image_name",
    "predictions": [
      {
        "type": "bbox" | "polygon" | "classification",
        "label": "category",
        "score": "confidence",
        "data": {
          "bbox": "bounding_box",  // [x, y, width, height]
          "polygon": "points"      // [[x1,y1], [x2,y2], ...]
        }
      }
    ]
  }
}
```

### JMESPath 表达式示例

#### 示例1：简单字段映射

原始数据：
```json
{
  "filename": "img1.jpg",
  "objects": [
    {
      "class": "car",
      "box": [10, 20, 100, 80],
      "conf": 0.95
    }
  ]
}
```

模板映射：
```json
{
  "image_key": "filename",
  "predictions": "objects[].{type: `bbox`, label: class, score: conf, data: {bbox: box}}"
}
```

#### 示例2：嵌套数组提取

原始数据：
```json
{
  "images": [
    {
      "id": 1,
      "path": "img1.jpg",
      "detections": [...]
    }
  ]
}
```

模板配置：
```json
{
  "record_path": "images",
  "mapping": {
    "image_key": "path",
    "predictions": "detections[].{type: `bbox`, ...}"
  }
}
```

### 调试技巧

1. **使用测试功能**：在导入页面点击「Test Parse」，查看解析结果
2. **逐步构建表达式**：先测试简单的字段提取，再组合复杂逻辑
3. **参考内置模板**：查看 COCO、YOLO、VOC 模板的实现
4. **JMESPath 在线工具**：https://jmespath.org/ 测试表达式

---

## 附录

### 系统要求

#### 服务器端

- **CPU**: 2核+
- **内存**: 4GB+
- **存储**: 根据数据集大小，建议预留数据集大小的 20% 空间（缩略图）
- **网络**: 内网访问即可（如需公网，建议配置 Nginx 反向代理 + HTTPS）

#### 客户端

- **浏览器**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **网络**: 建议内网带宽 ≥ 10Mbps（慢网环境下，虚拟列表和缓存会自动优化）

### 技术栈

- **后端**: FastAPI + SQLAlchemy + PostgreSQL
- **前端**: React 18 + TypeScript + Vite + Tailwind CSS + shadcn/ui
- **画布**: Fabric.js (检测/分割标注)
- **图表**: Recharts (Dashboard)
- **部署**: Docker + Docker Compose

### 版本历史

- **v0.1.0 (M0)**: 基础框架，分类标注
- **v0.2.0 (M1)**: BBox/Polygon 画布交互 + 快捷键系统 + Undo/Redo
- **v0.3.0 (M2)**: 效率优化（虚拟列表、预取、缓存）+ 预标注导入 + 数据导出
- **v1.0.0 (M3)**: 统计Dashboard + 文档完善 + 质量保障

---

**© 2025 LabelHub. MIT License.**

